<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}

    <link rel="stylesheet" type="text/css" href="{% static 'mintool/reset.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'mintool/text.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'mintool/960.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'mintool/mintool.css' %}"/>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            $(".terminus").click(function (e) {
                e.preventDefault();
                $('.terminus').removeAttr('style');
                $('#' + $(this).data('rel')).css("background", "LightSlateGray");
            });
            $(".isoform_display").click(function (e) {
                e.preventDefault();
                $(this).css("background", "LightSlateGray").siblings("div").removeAttr('style');
            });

        });
    </script>
    <title>results</title>

</head>
<body>
<div class="container_12">
    <div class="grid_12" id="header">MINtool</div>
    <div class="clear"></div>

    <div class="grid_12" id="nav-bar"></div>
    <div class="clear"></div>
    <div class="grid_12" id="seperator"></div>
    <div class="clear"></div>
    <div class="grid_4">
        <div class="grid_4 alpha" id="sub_header">I. Gene Info</div>
        {% for Gene in result %}
            <div class="grid_4 {% if forloop.last %} omega"{% endif %} id="result" acc={{ Gene.Accession }}>
                <p id="gene_name">{{ Gene.Gene_Name }} </p>
                <p>{{ Gene.Description }}</p>
            </div>
        {% endfor %}
    </div>
    <div class="grid_4">
        <div class="grid_4 alpha" id="sub_header">II. Select Isoform</div>
        <div class="grid_4 omega" id="isoform-overview"></div>

    </div>
    <div class="grid_4">
        <div class="grid_4 alpha" id="sub_header">III. Select Terminus</div>
        <div class="grid_4">
            <p id="gene_name">N- or C-terminal MIN-tagging?</p>
            <p>Please choose the terminus that you would like to MIN-tag. It is important to note that many
                functional modules of the MIN-tag toolbox require N-terminal targeting (e.g. knock-out, BioID,
                GFP knock-in, ...). However, some proteins are inhibited by N-terminal tagging and can only be
                tagged C-terminally. If there is no prior knowledge about your protein of interest regarding this,
                it should be tested in advance e.g. with GFP-fusions constructs. So choose wisely, ...
            </p>
        </div>
        <div class="grid_4">
            <div class="terminus" id="N-term" data-rel="N-term">N-terminus</div>
        </div>
        <div class="grid_4" id="spacer12"></div>
        <div class="grid_4">
            <div class="terminus" id="C-term" data-rel="C-term">C-terminus</div>
        </div>
        <div class="grid_4 omega"></div>
    </div>
    <div class="clear"></div>
    <div class="grid_12" id="sub_header">IV. Choos a gRNA</div>
    <div class="clear"></div>
</div>


<script>
    function numberWithCommas(x) {
        var parts = x.toString().split(".");
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join(".");
    }
    {% for Gene in result %}
        var rulerTicks = [{{ Gene.From }}, {{ Gene.To }}];
        var divRuler = d3.select("#isoform-overview").append("div")
            .attr("class", "ruler")
            .attr("id", {{ Gene.Accession }});
        var svgRuler = divRuler.append("svg")
            .attr("width", 300)
            .attr("height", 50);
        var locus = svgRuler.append("line")
            .attr("x1", 0)
            .attr("x2", 300)
            .attr("y1", 32.5)
            .attr("y2", 32.5)
            .attr("stroke-width", 3.5)
            .attr("stroke", "black");
        var svgLocusText = svgRuler.append("text")
            .attr("x", 150)
            .attr("y", 10)
            .text("{{ Gene.Gene_Name }} locus")
            .attr("text-anchor", "middle")
            .attr("font-family", "helvetica")
            .attr("font-size", 12);
        var svgLocusText2 = svgRuler.append("text")
            .attr("x", 150)
            .attr("y", 22)
            .text("chr{{ Gene.chr }}:" + numberWithCommas(rulerTicks[0]) + "-" + numberWithCommas(rulerTicks[1]))
            .attr("text-anchor", "middle")
            .attr("font-family", "courier new")
            .attr("font-size", 10);

        var isoform_data = {{ Gene.Isoforms|safe }};
        var ContainerDiv = d3.select("#isoform-overview").append("div")
            .attr("class", "container");
        for (var i = 0; i < isoform_data.length; i++) {
            var isoform = JSON.parse(isoform_data[i]);
            var divIsoforms = ContainerDiv.append("div")
                .attr("class", "isoform_display")
                .attr("id", isoform.Accession_nucleotide);
            var svgContainer = divIsoforms.append("svg")
                .attr("width", 300)
                .attr("height", 50)
            var svgTextName = svgContainer.append("text")
                .attr("x", 5)
                .attr("y", 10)
                .text(isoform.Name)
                .attr("font-family", "helvetica")
                .attr("letter-spacing", "1px")
                .attr("font-size", 10);
            var rectangle = svgContainer.selectAll("rect")
                .data(isoform.Exons)
                .enter()
                .append("rect")
                .attr("x", function (d) {
                    return d[1]
                })
                .attr("y", 20)
                .attr("fill", "black")
                .attr("width", function (d) {
                    var returnVal;
                    if (d[0] - d[1] == 0) {
                        returnVal = 1;
                    } else {
                        returnVal = d[0] - d[1];
                    }
                    return returnVal;
                })
                .attr("height", "25");
            var min = 1000000000000000000;
            var max = 0;
            for (var x = 0; x < isoform.Exons.length; x++) {
                if (isoform.Exons[x][1] < min) {
                    min = isoform.Exons[x][1];
                }
                if (isoform.Exons[x][0] > max) {
                    max = isoform.Exons[x][0];
                }
            }
            var line = svgContainer.append("line")
                .attr("x1", min)
                .attr("x2", max)
                .attr("y1", 32.5)
                .attr("y2", 32.5)
                .attr("stroke-width", 1)
                .attr("stroke", "black");

        }

    {% endfor %}
</script>
</body>
</html>